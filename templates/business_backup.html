<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Center - {{ hotel_name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>üéõÔ∏è CONTROL CENTER</h1>
        
        <nav class="nav">
            <button onclick="showSection('rooms')" class="nav-btn active" id="rooms-btn">üè® ROOM STATUS</button>
            <button onclick="showSection('bookings')" class="nav-btn" id="bookings-btn">üìã BOOKINGS</button>
            <button onclick="showSection('room-management')" class="nav-btn" id="room-management-btn">üõå ROOM MANAGEMENT</button>
            <button onclick="showSection('photos')" class="nav-btn" id="photos-btn">üì∏ PHOTOS</button>
            <button onclick="showSection('staff')" class="nav-btn" id="staff-btn">üë• STAFF NETWORK</button>
            <button onclick="showSection('menu')" class="nav-btn" id="menu-btn">üçΩÔ∏è MENU MATRIX</button>
            <button onclick="showSection('analytics')" class="nav-btn" id="analytics-btn">üìä DATA STREAM</button>
            <button onclick="logout()" class="nav-btn" style="margin-left: auto; background: linear-gradient(135deg, #ff4757, #ff3742); color: white;">üö™ DISCONNECT</button>
        </nav>

        <div id="rooms" class="section-content">
            <div class="card">
                <h2>üè® ROOM MONITORING SYSTEM</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Real-time room status and service requests</p>
                
                <!-- Room Stats Overview -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--accent-neon);">24</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">AVAILABLE</div>
                    </div>
                    <div style="background: rgba(255, 165, 0, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 165, 0, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: #ffa500;">476</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">OCCUPIED</div>
                    </div>
                    <div style="background: rgba(255, 0, 0, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 0, 0, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: #ff6b6b;">12</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">PENDING ORDERS</div>
                    </div>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--accent-blue);">3</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">URGENT</div>
                    </div>
                </div>

                <!-- Filter Controls -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <select id="floor-filter" style="padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--text-light);">
                        <option value="">All Floors</option>
                        <option value="1">Floor 1</option>
                        <option value="2">Floor 2</option>
                        <option value="3">Floor 3</option>
                        <option value="4">Floor 4</option>
                        <option value="5">Floor 5</option>
                    </select>
                    <select id="status-filter" style="padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--text-light);">
                        <option value="">All Status</option>
                        <option value="available">Available</option>
                        <option value="occupied">Occupied</option>
                        <option value="pending">Pending Orders</option>
                    </select>
                    <input type="text" id="room-search" placeholder="Search room number..." style="padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: var(--text-light); min-width: 200px;">
                </div>

                <!-- Priority Orders (Always Visible) -->
                <div id="priority-orders" style="margin-bottom: 2rem; display: none;">
                    <h3 style="color: var(--accent-neon); margin-bottom: 1rem;">üö® ACTIVE ORDERS</h3>
                    <div id="priority-list"></div>
                </div>

                <!-- Room Grid (Filtered Results) -->
                <div>
                    <h3 style="margin-bottom: 1rem;">ROOM STATUS <span id="room-count" style="color: var(--text-gray); font-size: 0.9rem;"></span></h3>
                    <div id="rooms-grid" class="rooms-grid-compact"></div>
                </div>
            </div>
            
            <div id="room-modal" class="modal" style="display: none;">
                <div class="modal-content card">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <h2>üìã ROOM SERVICE DATA - ROOM <span id="modal-room-number"></span></h2>
                    <div id="room-details"></div>
                    <div style="margin: 2rem 0; padding: 1.5rem; background: rgba(0, 255, 136, 0.1); border-radius: 12px; border: 1px solid rgba(0, 255, 136, 0.3);">
                        <label style="display: block; margin-bottom: 0.75rem; color: var(--accent-neon); font-weight: 700; text-transform: uppercase;">ASSIGN STAFF UNIT:</label>
                        <select id="staff-select" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); font-size: 1rem;">
                            <option value="">Select staff member...</option>
                        </select>
                    </div>
                    <button onclick="checkoutRoom()" class="btn" style="background: linear-gradient(135deg, #ff4757, #ff3742);">CHECKOUT ROOM</button>
                </div>
            </div>
        </div>

        <div id="bookings" class="section-content" style="display: none;">
            <div class="card">
                <h2>üìã BOOKING MANAGEMENT</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Manage room reservations and guest requests</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--accent-neon);">5</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">PENDING</div>
                    </div>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--accent-blue);">12</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">CONFIRMED</div>
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 12px; text-align: center; border: 1px solid rgba(139, 92, 246, 0.3);">
                        <div style="font-size: 2rem; font-weight: 900; color: var(--accent-purple);">8</div>
                        <div style="color: var(--text-gray); font-size: 0.8rem;">CHECKED IN</div>
                    </div>
                </div>
                
                <div>
                    <h3>BOOKING REQUESTS</h3>
                    <div id="bookings-list"></div>
                </div>
            </div>
        </div>

        <div id="room-management" class="section-content" style="display: none;">
            <div class="card">
                <h2>üõå ROOM MANAGEMENT</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Add and manage room types for your hotel</p>
                
                <div style="background: rgba(0, 255, 136, 0.1); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid rgba(0, 255, 136, 0.3);">
                    <h3>ADD NEW ROOM TYPE</h3>
                    <form id="add-room-type-form">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                            <input type="text" id="new-room-type" placeholder="Room Type (e.g., Deluxe)" required style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                            <input type="number" id="new-room-price" placeholder="Price per night" step="0.01" required style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                            <input type="number" id="new-room-guests" placeholder="Max guests" min="1" required style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                            <input type="number" id="new-room-count" placeholder="Number of rooms" min="1" required style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                            <input type="number" id="new-room-start" placeholder="Starting room number" required style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                        </div>
                        <input type="file" id="new-room-image" accept="image/*" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;">
                        <input type="url" id="new-room-image-url" placeholder="Or paste image URL" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;">
                        <textarea id="new-room-description" placeholder="Room description..." rows="2" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;"></textarea>
                        <button type="button" onclick="addRoomType()" class="btn">ADD ROOM TYPE</button>
                    </form>
                </div>
                
                <div>
                    <h3>EXISTING ROOM TYPES</h3>
                    <div id="room-types-list"></div>
                </div>
            </div>
        </div>

        <div id="photos" class="section-content" style="display: none;">
            <div class="card">
                <h2>üì∏ HOTEL PHOTOS</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Manage hotel images and room photos</p>
                
                <div style="background: rgba(0, 255, 136, 0.1); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid rgba(0, 255, 136, 0.3);">
                    <h3>HOTEL HEADER IMAGE</h3>
                    <input type="file" id="header-image-file" accept="image/*" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin: 1rem 0;">
                    <button onclick="uploadHeaderImage()" class="btn">UPLOAD HEADER</button>
                    <div id="header-upload-status" style="margin-top: 1rem; color: var(--text-gray);"></div>
                </div>
                
                <div style="background: rgba(0, 212, 255, 0.1); padding: 2rem; border-radius: 16px; border: 1px solid rgba(0, 212, 255, 0.3);">
                    <h3>HOTEL LOGO</h3>
                    <input type="file" id="logo-file" accept="image/*" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; color: var(--text-light); margin: 1rem 0;">
                    <button onclick="uploadLogo()" class="btn">UPLOAD LOGO</button>
                    <div id="logo-upload-status" style="margin-top: 1rem; color: var(--text-gray);"></div>
                </div>
            </div>
        </div>

        <div id="room-details-modal" class="modal" style="display: none;">
            <div class="modal-content card">
                <span class="close" onclick="closeRoomDetailsModal()">&times;</span>
                <h2 id="room-details-title">ROOM DETAILS</h2>
                <div id="room-photos-gallery" style="margin-bottom: 2rem;"></div>
                <div id="room-details-info"></div>
                <div style="margin-top: 2rem;">
                    <h3>ADD MORE PHOTOS</h3>
                    <input type="file" id="add-room-photo" accept="image/*" multiple style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;">
                    <button onclick="addRoomPhotos()" class="btn">ADD PHOTOS</button>
                </div>
            </div>
        </div>

        <div id="edit-room-modal" class="modal" style="display: none;">
            <div class="modal-content card">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h2>EDIT ROOM TYPE</h2>
                <input type="hidden" id="edit-room-original-type">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                    <input type="text" id="edit-room-type" placeholder="Room Type" style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                    <input type="number" id="edit-room-price" placeholder="Price per night" step="0.01" style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                    <input type="number" id="edit-room-guests" placeholder="Max guests" min="1" style="padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                </div>
                <input type="file" id="edit-room-image" accept="image/*" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;">
                <input type="url" id="edit-room-image-url" placeholder="Or paste image URL" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;">
                <textarea id="edit-room-description" placeholder="Room description..." rows="2" style="width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light); margin-bottom: 1rem;"></textarea>
                <button onclick="updateRoomType()" class="btn">UPDATE ROOM TYPE</button>
            </div>
        </div>

        <div id="staff" class="section-content" style="display: none;">
            <div class="card">
                <h2>üë• STAFF NETWORK MANAGEMENT</h2>
                
                <div style="background: rgba(0, 255, 136, 0.1); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid rgba(0, 255, 136, 0.3);">
                    <h3>ADD NEW STAFF UNIT</h3>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <input type="text" id="staff-input" placeholder="Enter staff member name" style="flex: 1; min-width: 250px; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; color: var(--text-light);">
                        <button onclick="addStaff()" class="btn">ADD UNIT</button>
                    </div>
                </div>
                
                <div>
                    <h3>ACTIVE STAFF UNITS</h3>
                    <div id="staff-container"></div>
                </div>
            </div>
        </div>

        <div id="menu" class="section-content" style="display: none;">
            <div class="card">
                <h2>üçΩÔ∏è MENU MATRIX CONTROL</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Manage room service offerings and availability</p>
                
                <div style="background: rgba(0, 212, 255, 0.1); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; border: 1px solid rgba(0, 212, 255, 0.3);">
                    <h3>üìÑ UPLOAD MENU DATA</h3>
                    <form id="upload-form" enctype="multipart/form-data" style="margin-top: 1rem;">
                        <input type="file" id="menu-file" accept=".xlsx,.xls,.pdf" required style="margin-bottom: 1rem; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; color: var(--text-light); width: 100%;">
                        <button type="submit" class="btn">UPLOAD MATRIX</button>
                    </form>
                </div>
                
                <div>
                    <h3>üç¥ MENU ITEMS DATABASE</h3>
                    <div id="menu-items-list"></div>
                </div>
            </div>
        </div>

        <div id="analytics" class="section-content" style="display: none;">
            <div class="card">
                <h2>üìä DATA STREAM ANALYTICS</h2>
                <p style="color: var(--text-gray); margin-bottom: 2rem;">Real-time performance metrics and insights</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div style="background: rgba(0, 255, 136, 0.1); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.3);">
                        <div style="font-size: 3rem; font-weight: 900; color: var(--accent-neon); margin-bottom: 0.5rem;">24</div>
                        <div style="color: var(--text-gray); text-transform: uppercase; font-weight: 600;">ACTIVE ROOMS</div>
                    </div>
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid rgba(0, 212, 255, 0.3);">
                        <div style="font-size: 3rem; font-weight: 900; color: var(--accent-blue); margin-bottom: 0.5rem;">156</div>
                        <div style="color: var(--text-gray); text-transform: uppercase; font-weight: 600;">ORDERS TODAY</div>
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.1); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid rgba(139, 92, 246, 0.3);">
                        <div style="font-size: 3rem; font-weight: 900; color: var(--accent-purple); margin-bottom: 0.5rem;">98%</div>
                        <div style="color: var(--text-gray); text-transform: uppercase; font-weight: 600;">SATISFACTION</div>
                    </div>
                    <div style="background: rgba(255, 165, 0, 0.1); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid rgba(255, 165, 0, 0.3);">
                        <div style="font-size: 3rem; font-weight: 900; color: #ffa500; margin-bottom: 0.5rem;">2.3m</div>
                        <div style="color: var(--text-gray); text-transform: uppercase; font-weight: 600;">AVG RESPONSE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'rooms';
        const hotelSubdomain = '{{ hotel_subdomain if hotel_subdomain else "" }}';

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            document.getElementById(sectionId + '-btn').classList.add('active');
            
            currentSection = sectionId;
            
            // Load section-specific data
            if (sectionId === 'rooms') {
                loadRooms();
            } else if (sectionId === 'bookings') {
                loadBookings();
            } else if (sectionId === 'room-management') {
                loadRoomTypes();
            } else if (sectionId === 'staff') {
                loadStaff();
            } else if (sectionId === 'menu') {
                loadMenu();
            } else if (sectionId === 'photos') {
                loadPhotos();
            }
        }

        let allRooms = [];
        let filteredRooms = [];

        async function loadRooms() {
            try {
                const url = hotelSubdomain ? `/business/rooms?hotel_subdomain=${hotelSubdomain}` : '/business/rooms';
                const response = await fetch(url);
                allRooms = await response.json();
            } catch (error) {
                console.error('Error loading rooms:', error);
                // Generate sample data for 500 rooms
                allRooms = [];
                for (let floor = 1; floor <= 5; floor++) {
                    for (let room = 1; room <= 100; room++) {
                        const roomNumber = floor * 100 + room;
                        const statuses = ['available', 'occupied', 'occupied', 'occupied']; // More occupied rooms
                        const status = statuses[Math.floor(Math.random() * statuses.length)];
                        const hasOrder = status === 'occupied' && Math.random() < 0.1; // 10% chance of order
                        
                        allRooms.push({
                            room_number: roomNumber,
                            status: status,
                            has_extra_order: hasOrder,
                            floor: floor,
                            order_time: hasOrder ? new Date(Date.now() - Math.random() * 3600000) : null
                        });
                    }
                }
            }
            
            updateRoomDisplay();
            loadPriorityOrders();
        }

        function updateRoomDisplay() {
            const floorFilter = document.getElementById('floor-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('room-search').value.toLowerCase();
            
            filteredRooms = allRooms.filter(room => {
                const matchesFloor = !floorFilter || room.floor.toString() === floorFilter;
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'pending' ? room.has_extra_order : room.status === statusFilter);
                const matchesSearch = !searchTerm || room.room_number.toString().includes(searchTerm);
                
                return matchesFloor && matchesStatus && matchesSearch;
            });
            
            // Limit display to 50 rooms for performance
            const displayRooms = filteredRooms.slice(0, 50);
            
            const grid = document.getElementById('rooms-grid');
            const countEl = document.getElementById('room-count');
            
            countEl.textContent = `(${displayRooms.length}${filteredRooms.length > 50 ? '+' : ''} of ${allRooms.length})`;
            
            grid.innerHTML = displayRooms.map(room => `
                <div class="room-card-compact ${room.status}" onclick="showRoomDetails(${room.room_number})">
                    <div class="room-number-compact">${room.room_number}</div>
                    ${room.has_extra_order ? '<div class="order-indicator">‚óè</div>' : ''}
                </div>
            `).join('');
        }

        function loadPriorityOrders() {
            const url = hotelSubdomain ? `/business/orders?hotel_subdomain=${hotelSubdomain}` : '/business/orders';
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const priorityList = document.getElementById('priority-list');
                    
                    if (data.length === 0) {
                        priorityList.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 1rem;">No active orders</div>';
                        return;
                    }
                    
                    // Group by order ID
                    const orders = {};
                    data.forEach(item => {
                        if (!orders[item.id]) {
                            orders[item.id] = {
                                id: item.id,
                                room_number: item.room_number,
                                created_at: item.created_at,
                                items: []
                            };
                        }
                        orders[item.id].items.push(`${item.name} x${item.qty}`);
                    });
                    
                    const orderList = Object.values(orders);
                    
                    priorityList.innerHTML = orderList.map(order => `
                        <div class="priority-order-card" onclick="showOrderDetails(${order.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 700; color: var(--text-light);">Room ${order.room_number}</div>
                                    <div style="color: var(--text-gray); font-size: 0.9rem;">${new Date(order.created_at).toLocaleTimeString()}</div>
                                    <div style="color: var(--accent-blue); font-size: 0.8rem; margin-top: 0.25rem;">${order.items.join(', ')}</div>
                                </div>
                                <button onclick="completeOrder(${order.id}); event.stopPropagation();" style="background: var(--accent-neon); color: var(--primary-dark); padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 0.8rem; cursor: pointer;">COMPLETE</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    document.getElementById('priority-list').innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 1rem;">Error loading orders</div>';
                });
        }

        async function showRoomDetails(roomNumber) {
            try {
                // Mark room as viewed (stop blinking)
                await fetch(`/business/mark-room-viewed/${roomNumber}`, { method: 'POST' });
                
                // Get all orders and filter by room number
                const response = await fetch('/test/orders');
                const allOrders = await response.json();
                
                // Get staff members
                const staffResponse = await fetch('/business/staff');
                const staff = await staffResponse.json();
                
                // Filter orders for this room
                const roomOrders = allOrders.filter(order => order.room_number === roomNumber);
                
                document.getElementById('modal-room-number').textContent = roomNumber;
                
                if (roomOrders.length > 0) {
                    // Group by order ID
                    const orders = {};
                    roomOrders.forEach(item => {
                        if (!orders[item.id]) {
                            orders[item.id] = {
                                id: item.id,
                                created_at: item.created_at,
                                items: []
                            };
                        }
                        orders[item.id].items.push(`${item.name} x${item.qty}`);
                    });
                    
                    const orderList = Object.values(orders);
                    
                    let orderHtml = '';
                    orderList.forEach(order => {
                        orderHtml += `
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; border: 1px solid rgba(0, 255, 136, 0.3);">
                                <p style="color: var(--text-gray); margin-bottom: 0.5rem;">Time: ${new Date(order.created_at).toLocaleString()}</p>
                                <div style="color: var(--text-light);">
                                    ${order.items.map(item => `<div style="margin: 0.25rem 0;">‚Ä¢ ${item}</div>`).join('')}
                                </div>
                            </div>
                        `;
                    });
                    document.getElementById('room-details').innerHTML = orderHtml;
                } else {
                    document.getElementById('room-details').innerHTML = `
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 12px; margin: 1rem 0;">
                            <p style="color: var(--text-gray);">No active orders for Room ${roomNumber}</p>
                        </div>
                    `;
                }
                
                // Populate staff dropdown
                const staffSelect = document.getElementById('staff-select');
                staffSelect.innerHTML = '<option value="">Select staff member...</option>';
                staff.forEach(member => {
                    staffSelect.innerHTML += `<option value="${member.id}">${member.name}</option>`;
                });
                
                document.getElementById('room-modal').style.display = 'flex';
                
                // Refresh room display to remove blinking
                loadRooms();
            } catch (error) {
                console.error('Error loading room details:', error);
                document.getElementById('modal-room-number').textContent = roomNumber;
                document.getElementById('room-details').innerHTML = `
                    <div style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 12px; margin: 1rem 0;">
                        <p style="color: var(--text-gray);">Error loading order details</p>
                    </div>
                `;
                document.getElementById('room-modal').style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('room-modal').style.display = 'none';
        }

        function completeOrder() {
            const roomNumber = document.getElementById('modal-room-number').textContent;
            
            // Complete all orders for this room
            fetch(`/business/complete-room-orders/${roomNumber}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('All orders completed successfully!');
                    closeModal();
                    loadRooms();
                })
                .catch(error => {
                    console.error('Error completing orders:', error);
                    alert('Error completing orders');
                });
        }

        function checkoutRoom() {
            const roomNumber = document.getElementById('modal-room-number').textContent;
            
            if (confirm(`Checkout Room ${roomNumber}? This will clear all orders and reset the room.`)) {
                fetch(`/business/checkout-room/${roomNumber}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert('Room checked out successfully!');
                        closeModal();
                        loadRooms();
                    })
                    .catch(error => {
                        console.error('Error checking out room:', error);
                        alert('Error checking out room');
                    });
            }
        }

        async function loadBookings() {
            try {
                const url = hotelSubdomain ? `/business/bookings?hotel_subdomain=${hotelSubdomain}` : '/business/bookings';
                const response = await fetch(url);
                const bookings = await response.json();
                
                const container = document.getElementById('bookings-list');
                
                if (bookings.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">No booking requests</div>';
                    return;
                }
                
                container.innerHTML = bookings.map(booking => `
                    <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--text-light); margin-bottom: 0.25rem;">${booking.guest_name}</div>
                                <div style="color: var(--text-gray); font-size: 0.9rem;">${booking.guest_email}</div>
                                <div style="color: var(--accent-blue); font-size: 0.9rem; margin-top: 0.25rem;">Room ${booking.room_number} ‚Ä¢ ${booking.total_nights} nights</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--accent-neon); font-weight: 700; font-size: 1.2rem;">$${booking.total_price}</div>
                                <div style="color: var(--text-gray); font-size: 0.8rem;">${booking.status.toUpperCase()}</div>
                            </div>
                        </div>
                        <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                            ${new Date(booking.check_in_date).toLocaleDateString()} - ${new Date(booking.check_out_date).toLocaleDateString()}
                        </div>
                        ${booking.status === 'pending' ? `
                            <div style="display: flex; gap: 1rem;">
                                <button onclick="updateBookingStatus(${booking.id}, 'confirmed')" style="background: var(--accent-neon); color: var(--primary-dark); padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">CONFIRM</button>
                                <button onclick="updateBookingStatus(${booking.id}, 'cancelled')" style="background: rgba(255, 0, 0, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 0, 0, 0.3); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">CANCEL</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookings-list').innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">Error loading bookings</div>';
            }
        }

        function updateBookingStatus(bookingId, status) {
            fetch(`/business/booking/${bookingId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                alert(`Booking ${status} successfully!`);
                loadBookings();
            })
            .catch(error => {
                console.error('Error updating booking:', error);
                alert('Error updating booking');
            });
        }
        async function loadRoomTypes() {
            try {
                const url = hotelSubdomain ? `/business/room-types?hotel_subdomain=${hotelSubdomain}` : '/business/room-types';
                const response = await fetch(url);
                const roomTypes = await response.json();
                
                const container = document.getElementById('room-types-list');
                
                if (roomTypes.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">No room types found.</div>';
                    return;
                }
                
                container.innerHTML = roomTypes.map(type => `
                    <div onclick="showRoomDetails('${type.room_type}')" style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 700; color: var(--text-light); margin-bottom: 0.25rem;">${type.room_type}</div>
                                <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${type.description || 'No description'}</div>
                                <div style="color: var(--accent-neon); font-weight: 700;">$${type.price_per_night}/night ‚Ä¢ ${type.max_guests} guests ‚Ä¢ ${type.total_rooms} rooms</div>
                            </div>
                            <button onclick="event.stopPropagation(); editRoomType('${type.room_type}', '${type.price_per_night}', '${type.max_guests}', '${(type.description || '').replace(/'/g, "&apos;")}')">EDIT</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading room types:', error);
                document.getElementById('room-types-list').innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">Error loading room types</div>';
            }
        }

        async function addRoomType() {
            const imageFile = document.getElementById('new-room-image').files[0];
            const imageUrlInput = document.getElementById('new-room-image-url').value;
            let imageUrl = imageUrlInput;
            
            if (imageFile && !imageUrlInput) {
                const formData = new FormData();
                formData.append('file', imageFile);
                formData.append('upload_preset', 'hotel_images');
                
                try {
                    const response = await fetch('https://api.cloudinary.com/v1_1/dzowvr6xu/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        imageUrl = data.secure_url;
                    } else {
                        alert('Image upload failed. Try using image URL instead.');
                        return;
                    }
                } catch (error) {
                    alert('Image upload failed. Try using image URL instead.');
                    return;
                }
            }
            
            const formData = {
                room_type: document.getElementById('new-room-type').value,
                price_per_night: parseFloat(document.getElementById('new-room-price').value),
                max_guests: parseInt(document.getElementById('new-room-guests').value),
                room_count: parseInt(document.getElementById('new-room-count').value),
                starting_room: parseInt(document.getElementById('new-room-start').value),
                description: document.getElementById('new-room-description').value,
                image_url: imageUrl
            };
            
            const url = hotelSubdomain ? `/business/add-room-type?hotel_subdomain=${hotelSubdomain}` : '/business/add-room-type';
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(result => {
                alert(`Added ${formData.room_count} ${formData.room_type} rooms successfully!`);
                document.getElementById('add-room-type-form').reset();
                loadRoomTypes();
            })
            .catch(error => {
                console.error('Error adding room type:', error);
                alert('Error adding room type');
            });
        }
        async function loadStaff() {
            try {
                const url = hotelSubdomain ? `/business/staff?hotel_subdomain=${hotelSubdomain}` : '/business/staff';
                const response = await fetch(url);
                const staff = await response.json();
                
                const container = document.getElementById('staff-container');
                
                if (staff.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">No staff members found.</div>';
                    return;
                }
                
                container.innerHTML = staff.map(member => `
                    <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-light); margin-bottom: 0.25rem;">${member.name}</div>
                            <div style="color: var(--text-gray); font-size: 0.9rem;">ACTIVE ‚Ä¢ ID: SF${member.id.toString().padStart(3, '0')}</div>
                        </div>
                        <button onclick="removeStaff(${member.id})" style="background: rgba(255, 0, 0, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 0, 0, 0.3); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">REMOVE</button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading staff:', error);
                document.getElementById('staff-container').innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">Error loading staff</div>';
            }
        }

        function addStaff() {
            const input = document.getElementById('staff-input');
            const name = input.value.trim();
            if (name) {
                alert(`Staff member "${name}" added to the network!`);
                input.value = '';
                loadStaff();
            }
        }

        function removeStaff(id) {
            if (confirm('Remove this staff member from the network?')) {
                alert('Staff member removed successfully!');
                loadStaff();
            }
        }

        async function loadMenu() {
            try {
                const url = hotelSubdomain ? `/business/menu?hotel_subdomain=${hotelSubdomain}` : '/business/menu';
                const response = await fetch(url);
                const menuItems = await response.json();
                
                const container = document.getElementById('menu-items-list');
                
                if (menuItems.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">No menu items found. Upload a menu to get started.</div>';
                    return;
                }
                
                // Group by category
                const categories = {};
                menuItems.forEach(item => {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });
                
                let html = '';
                Object.keys(categories).forEach(category => {
                    html += `<h4 style="color: var(--accent-neon); margin: 2rem 0 1rem 0; text-transform: uppercase;">${category}</h4>`;
                    categories[category].forEach(item => {
                        html += `
                            <div style="background: var(--card-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 700; color: var(--text-light); margin-bottom: 0.25rem;">${item.name}</div>
                                        <div style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 0.5rem;">${item.ingredients || 'No description available'}</div>
                                        <div style="color: var(--accent-neon); font-weight: 700; font-size: 1.2rem;">$${item.price.toFixed(2)}</div>
                                    </div>
                                    <button class="btn btn-secondary" style="padding: 0.5rem 1rem; margin-left: 1rem;">
                                        ${item.active ? 'ACTIVE' : 'INACTIVE'}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading menu:', error);
                document.getElementById('menu-items-list').innerHTML = '<div style="color: var(--text-gray); text-align: center; padding: 2rem;">Error loading menu</div>';
            }
        }
        
        async function loadPhotos() {
            // Load current photo URLs
        }
        
        async function uploadHeaderImage() {
            const fileInput = document.getElementById('header-image-file');
            const file = fileInput.files[0];
            if (!file) return;
            
            const status = document.getElementById('header-upload-status');
            status.textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'hotel_images');
            
            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/dzowvr6xu/image/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.secure_url) {
                    const endpoint = hotelSubdomain ? `/business/update-header?hotel_subdomain=${hotelSubdomain}` : '/business/update-header';
                    await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ header_image_url: data.secure_url })
                    });
                    
                    status.textContent = 'Header image uploaded successfully!';
                    status.style.color = 'var(--accent-neon)';
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                status.textContent = 'Upload failed. Please try again.';
                status.style.color = '#ff6b6b';
            }
        }
        
        async function uploadLogo() {
            const fileInput = document.getElementById('logo-file');
            const file = fileInput.files[0];
            if (!file) return;
            
            const status = document.getElementById('logo-upload-status');
            status.textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'hotel_images');
            
            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/dzowvr6xu/image/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.secure_url) {
                    const endpoint = hotelSubdomain ? `/business/update-logo?hotel_subdomain=${hotelSubdomain}` : '/business/update-logo';
                    await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ logo_url: data.secure_url })
                    });
                    
                    status.textContent = 'Logo uploaded successfully!';
                    status.style.color = 'var(--accent-neon)';
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                status.textContent = 'Upload failed. Please try again.';
                status.style.color = '#ff6b6b';
            }
        }
        
        async function showRoomDetails(roomType) {
            try {
                // Simple room details without complex query
                const roomTypes = await (await fetch(hotelSubdomain ? `/business/room-types?hotel_subdomain=${hotelSubdomain}` : '/business/room-types')).json();
                const room = roomTypes.find(r => r.room_type === roomType);
                
                if (!room) {
                    alert('Room not found');
                    return;
                }
                
                document.getElementById('room-details-title').textContent = `${roomType} ROOMS`;
                
                // Show basic photo (if exists)
                const gallery = document.getElementById('room-photos-gallery');
                gallery.innerHTML = '<div style="color: var(--text-gray);">No additional photos uploaded</div>';
                
                // Show room info
                document.getElementById('room-details-info').innerHTML = `
                    <div style="color: var(--text-light); margin-bottom: 1rem;">
                        <strong>Price:</strong> $${room.price_per_night}/night<br>
                        <strong>Max Guests:</strong> ${room.max_guests}<br>
                        <strong>Total Rooms:</strong> ${room.total_rooms}<br>
                        <strong>Description:</strong> ${room.description || 'No description'}
                    </div>
                `;
                
                document.getElementById('room-details-modal').style.display = 'flex';
            } catch (error) {
                alert('Error loading room details');
            }
        }
        
        function closeRoomDetailsModal() {
            document.getElementById('room-details-modal').style.display = 'none';
        }
        
        async function addRoomPhotos() {
            const files = document.getElementById('add-room-photo').files;
            if (files.length === 0) return;
            
            const roomType = document.getElementById('room-details-title').textContent.replace(' ROOMS', '');
            const photoUrls = [];
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'hotel_images');
                
                try {
                    const response = await fetch('https://api.cloudinary.com/v1_1/dzowvr6xu/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        photoUrls.push(data.secure_url);
                    }
                } catch (error) {
                    alert('Photo upload failed');
                    return;
                }
            }
            
            // Save photos to database
            const endpoint = hotelSubdomain ? `/business/add-room-photos?hotel_subdomain=${hotelSubdomain}` : '/business/add-room-photos';
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ room_type: roomType, photos: photoUrls })
            })
            .then(response => response.json())
            .then(result => {
                alert('Photos added successfully!');
                showRoomDetails(roomType); // Refresh
            })
            .catch(error => {
                alert('Error saving photos');
            });
        }
        
        function editRoomType(roomType, price, guests, description) {
            document.getElementById('edit-room-original-type').value = roomType;
            document.getElementById('edit-room-type').value = roomType;
            document.getElementById('edit-room-price').value = price;
            document.getElementById('edit-room-guests').value = guests;
            document.getElementById('edit-room-description').value = description;
            document.getElementById('edit-room-modal').style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('edit-room-modal').style.display = 'none';
        }
        
        function closeRoomDetailsModal() {
            document.getElementById('room-details-modal').style.display = 'none';
        }
            document.getElementById('edit-room-original-type').value = roomType;
            document.getElementById('edit-room-type').value = roomType;
            document.getElementById('edit-room-price').value = price;
            document.getElementById('edit-room-guests').value = guests;
            document.getElementById('edit-room-description').value = description;
            document.getElementById('edit-room-modal').style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('edit-room-modal').style.display = 'none';
        }
        
        async function updateRoomType() {
            const imageFile = document.getElementById('edit-room-image').files[0];
            const imageUrlInput = document.getElementById('edit-room-image-url').value;
            let imageUrl = imageUrlInput;
            
            if (imageFile && !imageUrlInput) {
                const formData = new FormData();
                formData.append('file', imageFile);
                formData.append('upload_preset', 'hotel_images');
                
                try {
                    const response = await fetch('https://api.cloudinary.com/v1_1/dzowvr6xu/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.secure_url) {
                        imageUrl = data.secure_url;
                    }
                } catch (error) {
                    alert('Image upload failed');
                    return;
                }
            }
            
            const updateData = {
                original_room_type: document.getElementById('edit-room-original-type').value,
                room_type: document.getElementById('edit-room-type').value,
                price_per_night: parseFloat(document.getElementById('edit-room-price').value),
                max_guests: parseInt(document.getElementById('edit-room-guests').value),
                description: document.getElementById('edit-room-description').value,
                image_url: imageUrl
            };
            
            const url = hotelSubdomain ? `/business/update-room-type?hotel_subdomain=${hotelSubdomain}` : '/business/update-room-type';
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(result => {
                alert('Room type updated successfully!');
                closeEditModal();
                loadRoomTypes();
            })
            .catch(error => {
                alert('Error updating room type');
            });
        }
        
        function toggleMenuItem(itemId, currentStatus) {
            // This would make an API call to toggle the menu item status
            alert(`Menu item ${currentStatus ? 'deactivated' : 'activated'}!`);
            loadMenu(); // Reload to show updated status
        }

        function logout() {
            if (confirm('Disconnect from the control center?')) {
                localStorage.removeItem('access_token');
                window.location.href = '/business/login';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadRooms();
            
            // Add filter event listeners
            document.getElementById('floor-filter').addEventListener('change', updateRoomDisplay);
            document.getElementById('status-filter').addEventListener('change', updateRoomDisplay);
            document.getElementById('room-search').addEventListener('input', updateRoomDisplay);
            
            // Auto-refresh and check for new activity every 10 seconds
            setInterval(() => {
                if (currentSection === 'rooms') {
                    loadRooms();
                }
                checkForNewActivity();
            }, 10000);
        });

        // Check for new bookings and orders
        async function checkForNewActivity() {
            try {
                // Check for new bookings
                const bookingsResponse = await fetch('/business/bookings');
                const bookings = await bookingsResponse.json();
                const pendingBookings = bookings.filter(b => b.status === 'pending').length;
                
                // Check for new orders
                const ordersResponse = await fetch('/test/orders');
                const orders = await ordersResponse.json();
                const activeOrders = orders.length;
                
                // Update tab badges
                updateTabBadge('bookings-btn', pendingBookings);
                updateTabBadge('rooms-btn', activeOrders);
                
                // Show notifications for new activity
                if (pendingBookings > 0 && currentSection !== 'bookings') {
                    showNotification(`${pendingBookings} new booking request${pendingBookings > 1 ? 's' : ''}!`, 'booking');
                }
                
                if (activeOrders > 0 && currentSection !== 'rooms') {
                    showNotification(`${activeOrders} active order${activeOrders > 1 ? 's' : ''} pending!`, 'order');
                }
                
            } catch (error) {
                console.error('Error checking for new activity:', error);
            }
        }

        function updateTabBadge(tabId, count) {
            const tab = document.getElementById(tabId);
            let badge = tab.querySelector('.badge');
            
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge';
                    badge.style.cssText = 'background: #ff4757; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.7rem; margin-left: 0.5rem; font-weight: 700;';
                    tab.appendChild(badge);
                }
                badge.textContent = count;
            } else if (badge) {
                badge.remove();
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'booking' ? 'var(--accent-blue)' : 'var(--accent-neon)'};
                color: var(--primary-dark);
                padding: 1rem 1.5rem;
                border-radius: 12px;
                font-weight: 700;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                cursor: pointer;
            `;
            notification.textContent = message;
            
            // Add click handler to dismiss
            notification.onclick = () => notification.remove();
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Modal click outside to close
        document.getElementById('room-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        if (document.getElementById('edit-room-modal')) {
            document.getElementById('edit-room-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
        }
        
        if (document.getElementById('room-details-modal')) {
            document.getElementById('room-details-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRoomDetailsModal();
                }
            });
        }
        
        function logout() {
            window.location.href = '/business/login';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadRooms();
        });
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-gray);
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--accent-neon);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>